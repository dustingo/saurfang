# Saurfang V2 Fiber - 系统架构图

## 系统概述
Saurfang V2 Fiber 是一个基于Go Fiber框架的游戏运维工具平台，提供游戏服务器管理、任务调度、资源监控等功能的综合运维解决方案。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   前端层 (Frontend Layer)                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Web界面 (toofast.html)  │  AMIS Dashboard  │  iframe嵌入  │  监控面板        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 API网关层 (API Gateway Layer)                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Fiber Web Framework (v3)                                                       │
│  ├─ 中间件栈 (Middleware Stack)                                                  │
│  │  ├─ CORS 跨域处理                                                             │
│  │  ├─ 限流器 (Rate Limiter)                                                     │
│  │  ├─ 日志记录器 (Logger)                                                       │
│  │  ├─ 恢复器 (Recoverer)                                                   │
│  │  ├─ 请求ID (RequestID)                                                   │
│  │  └─ 认证中间件 (Auth Middleware)                                          │
│  └─ 路由注册 (Route Registration)                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                业务逻辑层 (Business Logic Layer)                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Handler层 (HTTP处理器)                                                       │
│  ├─ 用户管理 (UserHandler)                                                   │
│  │  ├─ 用户认证                                                              │
│  │  ├─ 邀请码管理                                                            │
│  │  └─ 权限控制                                                              │
│  ├─ 游戏管理 (GameHandler)                                                   │
│  │  ├─ 游戏服务器配置                                                        │
│  │  ├─ 游戏频道管理                                                          │
│  │  ├─ 逻辑服务器管理                                                        │
│  │  └─ 游戏组管理                                                            │
│  ├─ 任务管理 (TaskHandler)                                                   │
│  │  ├─ 定时任务 (CronJob)                                                   │
│  │  ├─ 自定义任务执行                                                        │
│  │  ├─ 部署任务                                                              │
│  │  ├─ 游戏配置管理                                                          │
│  │  └─ 文件上传                                                              │
│  ├─ CMDB管理 (CMDBHandler)                                                   │
│  │  ├─ 主机管理                                                              │
│  │  ├─ 分组管理                                                              │
│  │  ├─ 自动集成测试                                                          │
│  │  └─ 自动化测试                                                            │
│  ├─ 仪表板 (BoardHandler)                                                    │
│  │  ├─ 自定义任务统计                                                        │
│  │  ├─ 资源监控                                                              │
│  │  ├─ Nomad管理                                                             │
│  │  └─ 登录管理                                                              │
│  ├─ 凭证管理 (CredentialHandler)                                             │
│  ├─ 数据源管理 (DSHandler)                                                   │
│  └─ Nomad管理 (NomadHandler)                                                 │
│     └─ 节点管理                                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                服务层 (Service Layer)                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Tools/Package 服务                                                           │
│  ├─ 阿里云服务 (Aliyun)                                                      │
│  ├─ 华为云服务 (HuaweiYun)                                                   │
│  ├─ Nomad监控服务 (NomadMonitor)                                             │
│  ├─ SSH连接服务 (SSH)                                                        │
│  ├─ 自定义任务服务 (CustomTaskService)                                       │
│  ├─ 定时任务服务 (CronJob)                                                   │
│  ├─ 缓存服务 (Cache)                                                         │
│  ├─ 加密服务 (Crypto)                                                        │
│  ├─ 凭证管理服务 (Credential)                                                │
│  ├─ 路径管理服务 (Path)                                                      │
│  ├─ 文件解压服务 (Unzip)                                                     │
│  ├─ 排序服务 (Sort)                                                          │
│  ├─ 数据预处理服务 (Predata)                                                 │
│  ├─ 数据库工具 (DB)                                                          │
│  ├─ Ansible集成 (Ansible)                                                    │
│  ├─ OSS对象存储 (OSS)                                                        │
│  └─ AMIS组件生成 (AMIS)                                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                数据访问层 (Data Access Layer)                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Repository层                                                                 │
│  ├─ 基础ORM (Base ORM)                                                       │
│  └─ Nomad基础操作 (Base Nomad)                                               │
│                                                                                │
│  Model层 (数据模型)                                                           │
│  ├─ 用户模型 (User)                                                           │
│  ├─ 游戏相关模型                                                              │
│  │  ├─ 游戏服务器 (GameServer)                                               │
│  │  ├─ 游戏主机 (GameHost)                                                   │
│  │  ├─ 游戏频道 (GameChannel)                                                │
│  │  ├─ 游戏组 (GameGroup)                                                    │
│  │  └─ 服务器配置 (ServerConfig)                                             │
│  ├─ 任务模型 (Task)                                                           │
│  │  ├─ 定时任务 (CronJob)                                                   │
│  │  ├─ 自定义任务 (CustomTask)                                               │
│  │  ├─ 部署任务 (DeployTask)                                                 │
│  │  └─ 任务结果 (JobResult)                                                  │
│  ├─ 云服务模型                                                                │
│  │  ├─ 阿里云ECS (AliyunECS)                                                │
│  │  └─ 华为云ECS (HuaweiYunECS)                                             │
│  ├─ 基础设施模型                                                              │
│  │  ├─ 数据源 (DataSource)                                                   │
│  │  ├─ 凭证 (Credential)                                                     │
│  │  ├─ 通知 (Notice)                                                         │
│  │  ├─ 上传 (Upload)                                                         │
│  │  └─ Nomad作业 (NomadJob)                                                  │
│  └─ 自动同步模型 (AutoSync)                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                基础设施层 (Infrastructure Layer)                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  配置管理 (Configuration)                                                     │
│  ├─ MySQL数据库配置                                                           │
│  ├─ Redis缓存配置                                                             │
│  ├─ Asynq任务队列配置                                                         │
│  ├─ Consul服务发现配置                                                        │
│  ├─ Nomad集群配置                                                             │
│  └─ 环境变量配置 (.env)                                                       │
│                                                                                │
│  外部服务集成                                                                  │
│  ├─ MySQL数据库                                                               │
│  ├─ Redis缓存/消息队列                                                        │
│  ├─ Consul服务注册与发现                                                      │
│  ├─ Nomad集群管理                                                             │
│  ├─ 阿里云API                                                                 │
│  ├─ 华为云API                                                                 │
│  └─ Ansible自动化工具                                                         │
└─────────────────────────────────────────────────────────────────────────────────┘

## 核心组件说明

### 1. Web框架层
- **Fiber v3**: 高性能Go Web框架，支持中间件扩展
- **中间件栈**: 提供跨域、限流、日志、认证等基础功能

### 2. 业务模块
- **用户管理**: 完整的用户认证和权限管理系统
- **游戏运维**: 游戏服务器、频道、配置的集中管理
- **任务调度**: 基于Asynq的异步任务处理系统
- **CMDB**: 配置管理数据库，管理主机和分组信息
- **监控仪表板**: 实时监控和统计展示

### 3. 数据存储
- **MySQL**: 主数据库，存储业务数据
- **Redis**: 缓存和消息队列，支持Asynq任务调度
- **文件存储**: 支持游戏包上传和部署

### 4. 外部集成
- **Consul**: 服务发现和配置管理
- **Nomad**: 容器编排和任务调度
- **云服务**: 阿里云、华为云等云平台集成
- **Ansible**: 自动化配置管理

## 数据流图

```
用户请求 → Fiber中间件 → 业务Handler → 服务层 → 数据层 → 外部服务
    ↓
响应返回 ← 数据层 ← 服务层 ← 业务Handler ← 中间件处理 ← 用户
```

## 部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器     │    │   负载均衡器     │    │   负载均衡器     │
│   (Nginx/LB)    │    │   (Nginx/LB)    │    │   (Nginx/LB)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Saurfang     │    │   Saurfang      │    │   Saurfang      │
│   Instance 1   │    │   Instance 2    │    │   Instance N    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────┴─────────────┐
                    │                           │
            ┌───────────────┐         ┌───────────────┐
            │    MySQL     │         │     Redis     │
            │   Cluster    │         │    Cluster    │
            └───────────────┘         └───────────────┘
                    │                           │
            ┌───────────────┐         ┌───────────────┐
            │    Consul    │         │     Nomad     │
            │   Cluster    │         │    Cluster    │
            └───────────────┘         └───────────────┘
```

## 技术栈总结

- **后端框架**: Go + Fiber v3
- **数据库**: MySQL + Redis
- **任务队列**: Asynq
- **服务发现**: Consul
- **容器编排**: Nomad
- **云服务**: 阿里云、华为云
- **自动化**: Ansible
- **前端**: AMIS + HTML
- **部署**: 支持容器化部署

## 系统特点

1. **微服务架构**: 模块化设计，易于扩展和维护
2. **高可用性**: 支持多实例部署和负载均衡
3. **任务调度**: 异步任务处理，提高系统响应性
4. **云原生**: 支持容器化部署和云服务集成
5. **监控完善**: 内置性能监控和健康检查
6. **安全可靠**: 完整的认证和权限管理体系
